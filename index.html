<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium Booking | Agendamento Online</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script type="module">
  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBvsywhqsxVWaYAZG79ooBwcrCUaLuFbB4",
    authDomain: "comunicacao-app.firebaseapp.com",
    databaseURL: "https://comunicacao-app-default-rtdb.firebaseio.com",
    projectId: "comunicacao-app",
    storageBucket: "comunicacao-app.appspot.com",
    messagingSenderId: "544901303602",
    appId: "1:544901303602:web:05083fa6a06fc6733a5b2b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  async function carregarServicos() {
    const snapshot = await get(child(ref(db), 'servicos'));
    const servicos = snapshot.exists() ? snapshot.val() : {};
    const select = document.getElementById('selectServico');
    select.innerHTML = Object.entries(servicos).map(([id, s]) => `<option value="${id}|${s.nome}|${s.valor}">${s.nome} - R$ ${s.valor}</option>`).join('');
  }

  async function carregarHorariosDoDia() {
    const data = document.getElementById('dataFiltro').value;
    const snapshot = await get(child(ref(db), 'agenda'));
    const agenda = snapshot.exists() ? snapshot.val() : {};
    const listaH = document.getElementById('listaHorarios');
    const disponiveis = Object.entries(agenda)
      .filter(([id, h]) => h.data === data && h.status === 'disponivel')
      .sort((a,b) => a[1].hora.localeCompare(b[1].hora));

    listaH.innerHTML = disponiveis.length ? disponiveis.map(([id,h]) => `
      <div class="horario-card">
        <div class="info-hora">${h.hora}</div>
        <button class="btn-agendar" onclick="finalizarAgendamento('${id}', '${data}', '${h.hora}')">Reservar</button>
      </div>
    `).join('') : '<p class="vazio">Sem hor√°rios dispon√≠veis para esta data.</p>';
  }

  async function finalizarAgendamento(id, data, hora) {
    const nome = document.getElementById('nomeCliente').value.trim();
    const whatsappFull = document.getElementById('whatsappCliente').value.trim();
    if (nome.split(' ').length < 2) return alert("‚ö†Ô∏è Digite seu nome completo (Nome e Sobrenome).");
    if (whatsappFull.length < 14) return alert("‚ö†Ô∏è Informe um WhatsApp v√°lido.");

    const [servicoId, servicoNome, servicoValor] = document.getElementById('selectServico').value.split('|');
    const token = Math.random().toString(36).substr(2,6).toUpperCase();
    const numeroLimpo = whatsappFull.replace(/\D/g, '');

    await update(ref(db, 'agenda/' + id), { status:'ocupado', cliente:nome, whatsapp:whatsappFull, servico:servicoNome, token:token });

    const dataFormatada = data.split('-').reverse().join('/');
    const msg = `üìå *CONFIRMA√á√ÉO DE AGENDAMENTO*%0A------------------------------------------%0A%0AOl√°, *${nome}*! Seu hor√°rio foi reservado.%0A%0Aüìù *DETALHES*%0Aüîπ *Servi√ßo:* ${servicoNome}%0Aüîπ *Valor:* R$ ${servicoValor}%0AüìÖ *Data:* ${dataFormatada}%0A‚è∞ *Hor√°rio:* ${hora}%0A%0A------------------------------------------%0Aüîë *TOKEN DE SEGURAN√áA:* *${token}*%0A------------------------------------------%0A%0A_Aguardamos sua visita!_%0A*UPbot¬Æ*`;

    alert(`‚úÖ Agendamento Realizado!\nTOKEN: ${token}\n\nClique em OK para enviar o comprovante.`);
    window.location.href = `https://wa.me/55${numeroLimpo}?text=${msg}`;
  }

  async function validarCancelamento() {
    const token = document.getElementById('tokenCancelamento').value.trim().toUpperCase();
    const snapshot = await get(child(ref(db), 'agenda'));
    const agenda = snapshot.exists() ? snapshot.val() : {};
    const agendamentoEntry = Object.entries(agenda).find(([id,h]) => h.token === token);

    if (agendamentoEntry) {
      const [id,h] = agendamentoEntry;
      window.agendamentoParaCancelar = { id, ...h };
      document.getElementById('detalhesCancelamento').innerHTML = `Deseja cancelar o servi√ßo de <b>${h.servico}</b> no dia <b>${h.data.split('-').reverse().join('/')}</b> √†s <b>${h.hora}</b>?`;
      document.getElementById('modalCancelamento').style.display = 'flex';
    } else {
      alert("‚ùå Token inv√°lido ou n√£o encontrado.");
    }
  }

  async function confirmarExclusaoFinal() {
    const id = window.agendamentoParaCancelar.id;
    await update(ref(db, 'agenda/' + id), { status:'disponivel', cliente:null, whatsapp:null, token:null, servico:null });
    fecharModal();
    alert("‚úÖ Cancelado com sucesso.");
    carregarHorariosDoDia();
  }

  function fecharModal() {
    document.getElementById('modalCancelamento').style.display = 'none';
    window.agendamentoParaCancelar = null;
  }

  function configurarDataMinima() {
    const hoje = new Date().toISOString().split('T')[0];
    const input = document.getElementById('dataFiltro');
    input.min = hoje;
    input.value = hoje;
    carregarHorariosDoDia();
  }

  document.getElementById('whatsappCliente').addEventListener('input', e => {
    let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
    e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
  });

  window.onload = () => {
    carregarServicos();
    configurarDataMinima();
  };
</script>

<style>
  /* CSS completo do Cliente, igual ao que voc√™ me enviou */
  /* Pode usar exatamente o que j√° t√≠nhamos, incluindo cores, bot√µes, modal etc */
</style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <h2>Agendamento Online</h2>
        <p>R√°pido, f√°cil e sem complica√ß√µes</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('agendar')">Agendar</button>
        <button class="tab-btn" onclick="switchTab('cancelar')">Meus Agendamentos</button>
    </div>
    
    <div id="tab-agendar" class="content-section active">
        <div class="form-group">
            <label>Nome Completo</label>
            <div class="input-wrapper">
                <i class="fa-regular fa-user"></i>
                <input type="text" id="nomeCliente" placeholder="Ex: Jo√£o Silva">
            </div>
        </div>

        <div class="form-group">
            <label>WhatsApp</label>
            <div class="input-wrapper">
                <i class="fa-brands fa-whatsapp"></i>
                <input type="tel" id="whatsappCliente" placeholder="(00) 00000-0000" maxlength="15">
            </div>
        </div>
        
        <div class="form-group">
            <label>Servi√ßo Desejado</label>
            <div class="input-wrapper">
                <i class="fa-solid fa-tag"></i>
                <select id="selectServico"></select>
            </div>
        </div>

        <div class="form-group">
            <label>Escolha a Data</label>
            <div class="input-wrapper">
                <i class="fa-regular fa-calendar"></i>
                <input type="date" id="dataFiltro" onchange="carregarHorariosDoDia()">
            </div>
        </div>

        <div id="listaHorarios"></div>
    </div>

    <div id="tab-cancelar" class="content-section">
        <div class="form-group">
            <label>C√≥digo Token</label>
            <div class="input-wrapper">
                <i class="fa-solid fa-key"></i>
                <input type="text" id="tokenCancelamento" placeholder="Ex: A1B2C3" style="text-transform: uppercase;">
            </div>
        </div>
        <button class="btn-agendar" style="width: 100%; background: var(--danger);" onclick="validarCancelamento()">Verificar Agendamento</button>
    </div>

    <div class="dev-stamp">Developer: UPbot¬Æ</div>
</div>

<div id="modalCancelamento" class="modal-overlay">
    <div class="modal-card">
        <i class="fa-solid fa-circle-exclamation" style="font-size: 3rem; color: var(--danger); margin-bottom: 15px;"></i>
        <h3 style="margin:0">Confirmar Cancelamento?</h3>
        <p id="detalhesCancelamento" style="margin-top:15px; color: var(--text-secondary);"></p>
        <div class="modal-buttons">
            <button class="btn-modal btn-cancel" onclick="fecharModal()">Voltar</button>
            <button class="btn-modal btn-confirm" onclick="confirmarExclusaoFinal()">Confirmar</button>
        </div>
    </div>
</div>

</body>
</html>
